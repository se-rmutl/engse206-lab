# 6.6.4 Database & Sample Data - Agent Wallboard System

## 🎯 ภาพรวม

เอกสารนี้จะอธิบายโครงสร้างฐานข้อมูลของ Agent Wallboard System ที่ใช้ **Hybrid Database Architecture** คือ **SQLite** สำหรับ master data และ **MongoDB** สำหรับ real-time data รวมถึง sample data ที่เตรียมไว้สำหรับการทดสอบ พร้อมคำแนะนำการติดตั้งและตรวจสอบที่ละเอียด

### 🎓 เป้าหมายการเรียนรู้
เมื่อจบการอ่านเอกสารนี้ นักศึกษาจะสามารถ:
- ✅ เข้าใจเหตุผลการใช้ 2 database systems
- ✅ รู้จัก database schema และ table/collection structure
- ✅ ติดตั้งและเตรียม databases พร้อม sample data
- ✅ ตรวจสอบความถูกต้องของข้อมูลด้วยตัวเอง
- ✅ เข้าใจความสัมพันธ์ระหว่างข้อมูลใน SQLite และ MongoDB

---

## 🏗️ Database Architecture Overview

### 🎯 ทำไมต้องใช้ 2 Databases?

```
📊 SQLite (Master Data)          🍃 MongoDB (Real-time Data)
├── 👥 agents (13 records)      ├── messages (dynamic)
├── 🏢 teams (3 records)        ├── agent_status (dynamic)
└── ⚙️ system_config (8 records) └── connection_logs (dynamic)
```

### 📊 SQLite - เหตุผลการเลือกใช้

**ข้อดี:**
- ✅ **ไม่ต้องติดตั้ง Server** - เป็นไฟล์เดียว พกพาง่าย
- ✅ **ACID Compliance** - ความถูกต้องของข้อมูล 100%
- ✅ **Foreign Keys** - ตรวจสอบความสัมพันธ์ระหว่างตารางอัตโนมัติ
- ✅ **SQL Standard** - ใช้ SQL ธรรมดาที่คุ้นเคย

**ใช้สำหรับข้อมูล:**
- ข้อมูล Agents และ Supervisors
- โครงสร้างทีม (Teams)
- การตั้งค่าระบบ (System Config)

### 🍃 MongoDB - เหตุผลการเลือกใช้

**ข้อดี:**
- ⚡ **เขียนข้อมูลเร็วมาก** - รองรับ real-time updates
- 📈 **Flexible Schema** - เพิ่ม fields ใหม่ได้ง่าย
- 🔍 **Query Time-series** - หาข้อมูลตามช่วงเวลาเร็ว
- 📊 **Aggregation** - วิเคราะห์ข้อมูลได้ง่าย

**ใช้สำหรับข้อมูล:**
- การเปลี่ยนสถานะของ Agents (ทุกวินาที)
- ข้อความระหว่าง Supervisor และ Agents
- ประวัติการเชื่อมต่อ (Connection Logs)

---

## 📊 Part 1: SQLite Database

### 🗄️ ข้อมูลพื้นฐาน

```bash
📁 ตำแหน่งไฟล์: database/sqlite/wallboard.db
📏 ขนาดไฟล์: ~50KB (พร้อม sample data)
🔗 Connection String: sqlite:./database/sqlite/wallboard.db
```

### 📋 โครงสร้าง Tables

```sql
wallboard.db
├── teams (3 records)
│   └─┬─ team_id (PK)
│     └─ supervisor_code → agents.agent_code
│
├── agents (13 records)
│   ├─┬─ agent_code (PK)
│   │ └─ team_id → teams.team_id (FK)
│   ├─── 3 Supervisors (SP001-SP003)
│   └─── 10 Agents (AG001-AG010)
│
└── system_config (8 records)
    └─── config_key (PK)
```

---

### 1️⃣ Table: teams

**📝 คำอธิบาย:** เก็บข้อมูลทีมและผู้ดูแลแต่ละทีม

**📐 Schema:**
```sql
CREATE TABLE teams (
    team_id INTEGER PRIMARY KEY AUTOINCREMENT,
    team_name VARCHAR(50) NOT NULL UNIQUE,
    supervisor_code VARCHAR(10),
    description TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT 1
);

-- Index สำหรับ performance
CREATE INDEX idx_teams_supervisor ON teams(supervisor_code);
CREATE INDEX idx_teams_active ON teams(is_active);
```

**📊 Sample Data (3 records):**
```sql
INSERT INTO teams (team_id, team_name, supervisor_code, description) VALUES
(1, 'Customer Service', 'SP001', 'Main customer service team'),
(2, 'Technical Support', 'SP002', 'Technical support specialists'),
(3, 'Sales Team', 'SP003', 'Sales and marketing team');
```

**🔍 ความสัมพันธ์:**
```
teams.supervisor_code → agents.agent_code (WHERE role='supervisor')
teams.team_id ← agents.team_id
```

**💡 Query ตัวอย่าง:**
```sql
-- ดูข้อมูลทีมพร้อมชื่อ Supervisor
SELECT 
    t.team_name,
    t.supervisor_code,
    a.agent_name as supervisor_name,
    t.description
FROM teams t
LEFT JOIN agents a ON t.supervisor_code = a.agent_code
WHERE t.is_active = 1;

/* ผลลัพธ์:
Customer Service | SP001 | Sarah Wilson | Main customer service team
Technical Support | SP002 | Mike Johnson | Technical support specialists
Sales Team | SP003 | Lisa Chen | Sales and marketing team
*/
```

---

### 2️⃣ Table: agents

**📝 คำอธิบาย:** เก็บข้อมูล Agents และ Supervisors ทั้งหมด

**📐 Schema:**
```sql
CREATE TABLE agents (
    agent_id INTEGER PRIMARY KEY AUTOINCREMENT,
    agent_code VARCHAR(10) NOT NULL UNIQUE,
    agent_name VARCHAR(100) NOT NULL,
    team_id INTEGER NOT NULL,
    role VARCHAR(20) NOT NULL CHECK (role IN ('agent', 'supervisor')),
    email VARCHAR(100),
    phone VARCHAR(20),
    hire_date DATE,
    is_active BOOLEAN DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (team_id) REFERENCES teams(team_id)
);

-- Indexes สำหรับ performance
CREATE INDEX idx_agents_code ON agents(agent_code);
CREATE INDEX idx_agents_team ON agents(team_id);
CREATE INDEX idx_agents_role ON agents(role);
```

**📊 Sample Data (13 records):**

**🔹 Supervisors (3 คน):**
```sql
INSERT INTO agents (agent_code, agent_name, team_id, role, email, phone, hire_date) VALUES
('SP001', 'Sarah Wilson', 1, 'supervisor', 'sarah.wilson@company.com', '555-0101', '2023-01-15'),
('SP002', 'Mike Johnson', 2, 'supervisor', 'mike.johnson@company.com', '555-0102', '2023-01-20'),
('SP003', 'Lisa Chen', 3, 'supervisor', 'lisa.chen@company.com', '555-0103', '2023-02-01');
```

**🔹 Customer Service Team - Agents (4 คน):**
```sql
INSERT INTO agents (agent_code, agent_name, team_id, role, email, phone, hire_date) VALUES
('AG001', 'John Smith', 1, 'agent', 'john.smith@company.com', '555-0201', '2023-03-01'),
('AG002', 'Emma Davis', 1, 'agent', 'emma.davis@company.com', '555-0202', '2023-03-05'),
('AG003', 'Robert Brown', 1, 'agent', 'robert.brown@company.com', '555-0203', '2023-03-10'),
('AG004', 'Jennifer Wilson', 1, 'agent', 'jennifer.wilson@company.com', '555-0204', '2023-03-15');
```

**🔹 Technical Support Team - Agents (3 คน):**
```sql
INSERT INTO agents (agent_code, agent_name, team_id, role, email, phone, hire_date) VALUES
('AG005', 'David Miller', 2, 'agent', 'david.miller@company.com', '555-0301', '2023-04-01'),
('AG006', 'Amanda Taylor', 2, 'agent', 'amanda.taylor@company.com', '555-0302', '2023-04-05'),
('AG007', 'Chris Anderson', 2, 'agent', 'chris.anderson@company.com', '555-0303', '2023-04-10');
```

**🔹 Sales Team - Agents (3 คน):**
```sql
INSERT INTO agents (agent_code, agent_name, team_id, role, email, phone, hire_date) VALUES
('AG008', 'Michelle Garcia', 3, 'agent', 'michelle.garcia@company.com', '555-0401', '2023-05-01'),
('AG009', 'Kevin Martinez', 3, 'agent', 'kevin.martinez@company.com', '555-0402', '2023-05-05'),
('AG010', 'Jessica Rodriguez', 3, 'agent', 'jessica.rodriguez@company.com', '555-0403', '2023-05-10');
```

**💡 Query ตัวอย่าง:**
```sql
-- ดูโครงสร้างทีมทั้งหมด
SELECT 
    t.team_name,
    a.agent_code,
    a.agent_name,
    a.role,
    a.email
FROM agents a
JOIN teams t ON a.team_id = t.team_id
WHERE a.is_active = 1
ORDER BY t.team_id, a.role DESC, a.agent_name;

-- นับจำนวน Agents ในแต่ละทีม
SELECT 
    t.team_name,
    COUNT(CASE WHEN a.role = 'supervisor' THEN 1 END) as supervisors,
    COUNT(CASE WHEN a.role = 'agent' THEN 1 END) as agents,
    COUNT(*) as total
FROM teams t
LEFT JOIN agents a ON t.team_id = a.team_id AND a.is_active = 1
GROUP BY t.team_id, t.team_name;
```

---

### 3️⃣ Table: system_config

**📝 คำอธิบาย:** เก็บการตั้งค่าระบบต่างๆ

**📐 Schema:**
```sql
CREATE TABLE system_config (
    config_id INTEGER PRIMARY KEY AUTOINCREMENT,
    config_key VARCHAR(50) NOT NULL UNIQUE,
    config_value TEXT NOT NULL,
    description TEXT,
    is_active BOOLEAN DEFAULT 1,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_config_key ON system_config(config_key);
CREATE INDEX idx_config_active ON system_config(is_active);
```

**📊 Sample Data (8 records):**
```sql
INSERT INTO system_config (config_key, config_value, description) VALUES
('status_timeout', '300', 'Auto-offline timeout in seconds'),
('message_retention', '30', 'Message retention in days'),
('max_concurrent_sessions', '1', 'Max sessions per agent'),
('notification_enabled', 'true', 'Enable desktop notifications'),
('websocket_timeout', '30000', 'WebSocket timeout in milliseconds'),
('api_rate_limit', '100', 'API requests per minute'),
('session_duration', '28800', 'Max session duration in seconds (8 hours)'),
('backup_interval', '86400', 'Database backup interval in seconds (24 hours)');
```

**💡 การใช้งานใน Backend:**
```javascript
// อ่านค่า config
const timeout = await getConfig('status_timeout'); // "300"
const enabled = await getConfig('notification_enabled'); // "true"
```

---

## 🍃 Part 2: MongoDB Database

### 🗄️ ข้อมูลพื้นฐาน

```bash
📁 Database Name: wallboard
🔗 Connection URI: mongodb://localhost:27017/wallboard
📦 Collections: 3 collections
```

### 📋 โครงสร้าง Collections

```
wallboard (database)
├── messages (~100 documents per day)
│   ├── Direct messages
│   └── Broadcast messages
│
├── agent_status (~1000 documents per day)
│   └── Status change history
│
└── connection_logs (~50 documents per day)
    ├── Connect events
    └── Disconnect events
```

---

### 1️⃣ Collection: messages

**📝 คำอธิบาย:** เก็บข้อความทั้งหมดในระบบ (Direct และ Broadcast)

**📐 Schema (Mongoose):**
```javascript
const messageSchema = new mongoose.Schema({
  fromCode: {
    type: String,
    required: true,
    uppercase: true,
    index: true
  },
  toCode: {
    type: String,
    uppercase: true,
    index: true  // สำหรับ direct messages
  },
  toTeamId: {
    type: Number,
    index: true  // สำหรับ broadcast messages
  },
  content: {
    type: String,
    required: true,
    trim: true,
    maxlength: 500
  },
  type: {
    type: String,
    enum: ['direct', 'broadcast'],
    required: true
  },
  priority: {
    type: String,
    enum: ['low', 'normal', 'high'],
    default: 'normal'
  },
  isRead: {
    type: Boolean,
    default: false
  },
  readAt: {
    type: Date
  },
  timestamp: {
    type: Date,
    default: Date.now,
    index: true
  }
}, {
  collection: 'messages',
  timestamps: true
});

// Compound indexes สำหรับ query ที่เร็ว
messageSchema.index({ toCode: 1, timestamp: -1 });
messageSchema.index({ toTeamId: 1, timestamp: -1 });
messageSchema.index({ fromCode: 1, timestamp: -1 });
```

**📊 Sample Data:**
```javascript
// Direct Message ตัวอย่าง
{
  "_id": ObjectId("65a1b2c3d4e5f6789012345a"),
  "fromCode": "SP001",
  "toCode": "AG001",
  "content": "Please check your queue when you have time",
  "type": "direct",
  "priority": "normal",
  "isRead": false,
  "timestamp": ISODate("2024-01-15T10:30:00.000Z"),
  "createdAt": ISODate("2024-01-15T10:30:00.000Z"),
  "updatedAt": ISODate("2024-01-15T10:30:00.000Z")
}

// Broadcast Message ตัวอย่าง
{
  "_id": ObjectId("65a1b2c3d4e5f6789012345b"),
  "fromCode": "SP001",
  "toTeamId": 1,
  "content": "Team meeting at 2 PM today",
  "type": "broadcast",
  "priority": "high",
  "isRead": false,
  "timestamp": ISODate("2024-01-15T11:00:00.000Z"),
  "createdAt": ISODate("2024-01-15T11:00:00.000Z"),
  "updatedAt": ISODate("2024-01-15T11:00:00.000Z")
}
```

**💡 Query ตัวอย่าง:**
```javascript
// หาข้อความที่ส่งถึง Agent คนหนึ่ง (Direct + Broadcast)
db.messages.find({
  $or: [
    { toCode: "AG001" },
    { toTeamId: 1 }
  ]
}).sort({ timestamp: -1 }).limit(10);

// หาข้อความที่ยังไม่ได้อ่าน
db.messages.find({
  toCode: "AG001",
  isRead: false
}).sort({ timestamp: -1 });

// หาข้อความ priority สูง
db.messages.find({
  priority: "high",
  timestamp: { $gte: ISODate("2024-01-15T00:00:00.000Z") }
}).sort({ timestamp: -1 });
```

---

### 2️⃣ Collection: agent_status

**📝 คำอธิบาย:** เก็บประวัติการเปลี่ยนสถานะของ Agents

**📐 Schema (Mongoose):**
```javascript
const statusSchema = new mongoose.Schema({
  agentCode: {
    type: String,
    required: true,
    uppercase: true,
    index: true
  },
  status: {
    type: String,
    enum: ['Available', 'Busy', 'Break', 'Offline'],
    required: true
  },
  timestamp: {
    type: Date,
    default: Date.now,
    index: true
  },
  teamId: {
    type: Number,
    index: true
  },
  duration: {
    type: Number  // เวลาที่อยู่ใน status นี้ (วินาที)
  },
  sessionId: {
    type: String
  }
}, {
  collection: 'agent_status',
  timestamps: true
});

// Compound indexes
statusSchema.index({ agentCode: 1, timestamp: -1 });
statusSchema.index({ teamId: 1, timestamp: -1 });
statusSchema.index({ status: 1, timestamp: -1 });
```

**📊 Sample Data:**
```javascript
// Status change ตัวอย่าง
{
  "_id": ObjectId("65a1b2c3d4e5f6789012345c"),
  "agentCode": "AG001",
  "status": "Available",
  "timestamp": ISODate("2024-01-15T09:00:00.000Z"),
  "teamId": 1,
  "duration": 3600,  // อยู่ Available 1 ชั่วโมง
  "sessionId": "session_20240115_090000",
  "createdAt": ISODate("2024-01-15T09:00:00.000Z"),
  "updatedAt": ISODate("2024-01-15T10:00:00.000Z")
}

{
  "_id": ObjectId("65a1b2c3d4e5f6789012345d"),
  "agentCode": "AG001",
  "status": "Busy",
  "timestamp": ISODate("2024-01-15T10:00:00.000Z"),
  "teamId": 1,
  "duration": 1800,  // อยู่ Busy 30 นาที
  "sessionId": "session_20240115_090000",
  "createdAt": ISODate("2024-01-15T10:00:00.000Z"),
  "updatedAt": ISODate("2024-01-15T10:30:00.000Z")
}
```

**💡 Query ตัวอย่าง:**
```javascript
// ดูประวัติ status ของ Agent
db.agent_status.find({
  agentCode: "AG001"
}).sort({ timestamp: -1 }).limit(20);

// หา status ปัจจุบันของ Agent
db.agent_status.find({
  agentCode: "AG001"
}).sort({ timestamp: -1 }).limit(1);

// สรุปเวลาทำงานของ Agent
db.agent_status.aggregate([
  {
    $match: {
      agentCode: "AG001",
      timestamp: {
        $gte: ISODate("2024-01-15T00:00:00.000Z"),
        $lt: ISODate("2024-01-16T00:00:00.000Z")
      }
    }
  },
  {
    $group: {
      _id: "$status",
      totalDuration: { $sum: "$duration" },
      count: { $sum: 1 }
    }
  }
]);
```

---

### 3️⃣ Collection: connection_logs

**📝 คำอธิบาย:** เก็บประวัติการเชื่อมต่อ WebSocket ของ Agents

**📐 Schema (Mongoose):**
```javascript
const connectionLogSchema = new mongoose.Schema({
  agentCode: {
    type: String,
    required: true,
    uppercase: true,
    index: true
  },
  eventType: {
    type: String,
    enum: ['connect', 'disconnect', 'reconnect'],
    required: true
  },
  timestamp: {
    type: Date,
    default: Date.now,
    index: true
  },
  socketId: {
    type: String,
    required: true
  },
  ipAddress: {
    type: String
  },
  userAgent: {
    type: String
  },
  connectionDuration: {
    type: Number  // เวลาเชื่อมต่อ (วินาที)
  },
  disconnectReason: {
    type: String
  }
}, {
  collection: 'connection_logs',
  timestamps: true
});

// Compound indexes
connectionLogSchema.index({ agentCode: 1, timestamp: -1 });
connectionLogSchema.index({ eventType: 1, timestamp: -1 });
```

**📊 Sample Data:**
```javascript
// Connect event
{
  "_id": ObjectId("65a1b2c3d4e5f6789012345e"),
  "agentCode": "AG001",
  "eventType": "connect",
  "timestamp": ISODate("2024-01-15T09:00:00.000Z"),
  "socketId": "Xk3m5n7p9q",
  "ipAddress": "192.168.1.100",
  "userAgent": "Agent Desktop App v1.0",
  "createdAt": ISODate("2024-01-15T09:00:00.000Z"),
  "updatedAt": ISODate("2024-01-15T09:00:00.000Z")
}

// Disconnect event
{
  "_id": ObjectId("65a1b2c3d4e5f6789012345f"),
  "agentCode": "AG001",
  "eventType": "disconnect",
  "timestamp": ISODate("2024-01-15T17:00:00.000Z"),
  "socketId": "Xk3m5n7p9q",
  "connectionDuration": 28800,  // 8 ชั่วโมง
  "disconnectReason": "normal_logout",
  "createdAt": ISODate("2024-01-15T17:00:00.000Z"),
  "updatedAt": ISODate("2024-01-15T17:00:00.000Z")
}
```

**💡 Query ตัวอย่าง:**
```javascript
// ดูประวัติการเชื่อมต่อของ Agent
db.connection_logs.find({
  agentCode: "AG001"
}).sort({ timestamp: -1 }).limit(10);

// หาว่า Agent กำลังออนไลน์หรือไม่
db.connection_logs.find({
  agentCode: "AG001"
}).sort({ timestamp: -1 }).limit(1);

// วิเคราะห์ connection stability
db.connection_logs.aggregate([
  {
    $match: {
      agentCode: "AG001",
      eventType: "disconnect"
    }
  },
  {
    $group: {
      _id: "$disconnectReason",
      count: { $sum: 1 }
    }
  }
]);
```

---

## 🛠️ Database Setup & Installation

### ขั้นตอนที่ 1: เตรียม Environment

**1.1 สร้าง Folder Structure:**
```bash
mkdir -p database/sqlite
mkdir -p database/mongodb
```

**1.2 สร้างไฟล์ .env:**
```bash
# Database Configuration
SQLITE_DB_PATH=./database/sqlite/wallboard.db
MONGODB_URI=mongodb://localhost:27017/wallboard
```

---

### ขั้นตอนที่ 2: Setup SQLite

**2.1 สร้างไฟล์ `database/sqlite/init.sql`:**
```sql
-- Agent Wallboard System - SQLite Schema
-- Version: 1.0

-- Enable foreign keys
PRAGMA foreign_keys = ON;

-- Create teams table
CREATE TABLE IF NOT EXISTS teams (
    team_id INTEGER PRIMARY KEY AUTOINCREMENT,
    team_name VARCHAR(50) NOT NULL UNIQUE,
    supervisor_code VARCHAR(10),
    description TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT 1
);

-- Create agents table
CREATE TABLE IF NOT EXISTS agents (
    agent_id INTEGER PRIMARY KEY AUTOINCREMENT,
    agent_code VARCHAR(10) NOT NULL UNIQUE,
    agent_name VARCHAR(100) NOT NULL,
    team_id INTEGER NOT NULL,
    role VARCHAR(20) NOT NULL CHECK (role IN ('agent', 'supervisor')),
    email VARCHAR(100),
    phone VARCHAR(20),
    hire_date DATE,
    is_active BOOLEAN DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (team_id) REFERENCES teams(team_id)
);

-- Create system_config table
CREATE TABLE IF NOT EXISTS system_config (
    config_id INTEGER PRIMARY KEY AUTOINCREMENT,
    config_key VARCHAR(50) NOT NULL UNIQUE,
    config_value TEXT NOT NULL,
    description TEXT,
    is_active BOOLEAN DEFAULT 1,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_teams_supervisor ON teams(supervisor_code);
CREATE INDEX IF NOT EXISTS idx_teams_active ON teams(is_active);
CREATE INDEX IF NOT EXISTS idx_agents_code ON agents(agent_code);
CREATE INDEX IF NOT EXISTS idx_agents_team ON agents(team_id);
CREATE INDEX IF NOT EXISTS idx_agents_role ON agents(role);
CREATE INDEX IF NOT EXISTS idx_config_key ON system_config(config_key);
```

**2.2 สร้างไฟล์ `database/sqlite/sample_data.sql`:**
```sql
-- Sample Data for Agent Wallboard System

-- Insert teams
INSERT INTO teams (team_id, team_name, supervisor_code, description) VALUES
(1, 'Customer Service', 'SP001', 'Main customer service team'),
(2, 'Technical Support', 'SP002', 'Technical support specialists'),
(3, 'Sales Team', 'SP003', 'Sales and marketing team');

-- Insert supervisors
INSERT INTO agents (agent_code, agent_name, team_id, role, email, phone, hire_date) VALUES
('SP001', 'Sarah Wilson', 1, 'supervisor', 'sarah.wilson@company.com', '555-0101', '2023-01-15'),
('SP002', 'Mike Johnson', 2, 'supervisor', 'mike.johnson@company.com', '555-0102', '2023-01-20'),
('SP003', 'Lisa Chen', 3, 'supervisor', 'lisa.chen@company.com', '555-0103', '2023-02-01');

-- Insert Customer Service agents
INSERT INTO agents (agent_code, agent_name, team_id, role, email, phone, hire_date) VALUES
('AG001', 'John Smith', 1, 'agent', 'john.smith@company.com', '555-0201', '2023-03-01'),
('AG002', 'Emma Davis', 1, 'agent', 'emma.davis@company.com', '555-0202', '2023-03-05'),
('AG003', 'Robert Brown', 1, 'agent', 'robert.brown@company.com', '555-0203', '2023-03-10'),
('AG004', 'Jennifer Wilson', 1, 'agent', 'jennifer.wilson@company.com', '555-0204', '2023-03-15');

-- Insert Technical Support agents
INSERT INTO agents (agent_code, agent_name, team_id, role, email, phone, hire_date) VALUES
('AG005', 'David Miller', 2, 'agent', 'david.miller@company.com', '555-0301', '2023-04-01'),
('AG006', 'Amanda Taylor', 2, 'agent', 'amanda.taylor@company.com', '555-0302', '2023-04-05'),
('AG007', 'Chris Anderson', 2, 'agent', 'chris.anderson@company.com', '555-0303', '2023-04-10');

-- Insert Sales agents
INSERT INTO agents (agent_code, agent_name, team_id, role, email, phone, hire_date) VALUES
('AG008', 'Michelle Garcia', 3, 'agent', 'michelle.garcia@company.com', '555-0401', '2023-05-01'),
('AG009', 'Kevin Martinez', 3, 'agent', 'kevin.martinez@company.com', '555-0402', '2023-05-05'),
('AG010', 'Jessica Rodriguez', 3, 'agent', 'jessica.rodriguez@company.com', '555-0403', '2023-05-10');

-- Insert system configuration
INSERT INTO system_config (config_key, config_value, description) VALUES
('status_timeout', '300', 'Auto-offline timeout in seconds'),
('message_retention', '30', 'Message retention in days'),
('max_concurrent_sessions', '1', 'Max sessions per agent'),
('notification_enabled', 'true', 'Enable desktop notifications'),
('websocket_timeout', '30000', 'WebSocket timeout in milliseconds'),
('api_rate_limit', '100', 'API requests per minute'),
('session_duration', '28800', 'Max session duration in seconds (8 hours)'),
('backup_interval', '86400', 'Database backup interval in seconds (24 hours)');
```

**2.3 สร้าง Setup Script `database/sqlite/setup.sh`:**
```bash
#!/bin/bash

echo "🗄️ Setting up SQLite Database..."

DB_PATH="wallboard.db"

# Remove existing database
if [ -f "$DB_PATH" ]; then
    echo "⚠️  Existing database found. Removing..."
    rm "$DB_PATH"
fi

# Create database and schema
echo "📐 Creating database schema..."
sqlite3 "$DB_PATH" < init.sql

if [ $? -ne 0 ]; then
    echo "❌ Failed to create schema"
    exit 1
fi

# Insert sample data
echo "📊 Inserting sample data..."
sqlite3 "$DB_PATH" < sample_data.sql

if [ $? -ne 0 ]; then
    echo "❌ Failed to insert sample data"
    exit 1
fi

# Verify data
echo "🔍 Verifying data..."
AGENT_COUNT=$(sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM agents;")
TEAM_COUNT=$(sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM teams;")
CONFIG_COUNT=$(sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM system_config;")

echo "✅ SQLite Database setup completed!"
echo "📊 Summary:"
echo "   - Teams: $TEAM_COUNT"
echo "   - Agents: $AGENT_COUNT"
echo "   - Configs: $CONFIG_COUNT"
echo ""
echo "📁 Database location: $(pwd)/$DB_PATH"
```

**2.4 รัน Setup (Linux/Mac):**
```bash
cd database/sqlite
chmod +x setup.sh
./setup.sh
```

**2.5 รัน Setup (Windows - PowerShell):**
```powershell
cd database\sqlite
sqlite3 wallboard.db < init.sql
sqlite3 wallboard.db < sample_data.sql
```

---

### ขั้นตอนที่ 3: Setup MongoDB

**3.1 สร้างไฟล์ `database/mongodb/sample_data.js`:**
```javascript
const mongoose = require('mongoose');

// MongoDB Connection
const MONGODB_URI = process.env.MONGODB_URI || 'mongodb://localhost:27017/wallboard';

// Schema Definitions
const messageSchema = new mongoose.Schema({
  fromCode: { type: String, required: true, uppercase: true },
  toCode: { type: String, uppercase: true },
  toTeamId: { type: Number },
  content: { type: String, required: true },
  type: { type: String, enum: ['direct', 'broadcast'], required: true },
  priority: { type: String, enum: ['low', 'normal', 'high'], default: 'normal' },
  isRead: { type: Boolean, default: false },
  readAt: { type: Date },
  timestamp: { type: Date, default: Date.now }
}, { collection: 'messages' });

const statusSchema = new mongoose.Schema({
  agentCode: { type: String, required: true, uppercase: true },
  status: { type: String, enum: ['Available', 'Busy', 'Break', 'Offline'], required: true },
  timestamp: { type: Date, default: Date.now },
  teamId: { type: Number },
  duration: { type: Number }
}, { collection: 'agent_status' });

const connectionLogSchema = new mongoose.Schema({
  agentCode: { type: String, required: true, uppercase: true },
  eventType: { type: String, enum: ['connect', 'disconnect', 'reconnect'], required: true },
  timestamp: { type: Date, default: Date.now },
  socketId: { type: String, required: true },
  ipAddress: { type: String },
  userAgent: { type: String },
  connectionDuration: { type: Number }
}, { collection: 'connection_logs' });

// Create Models
const Message = mongoose.model('Message', messageSchema);
const AgentStatus = mongoose.model('AgentStatus', statusSchema);
const ConnectionLog = mongoose.model('ConnectionLog', connectionLogSchema);

// Sample Data
async function insertSampleData() {
  try {
    console.log('🧹 Clearing existing data...');
    await Message.deleteMany({});
    await AgentStatus.deleteMany({});
    await ConnectionLog.deleteMany({});

    console.log('💬 Inserting sample messages...');
    const sampleMessages = [
      {
        fromCode: "SP001",
        toCode: "AG001",
        content: "Good morning! Ready for the day?",
        type: "direct",
        priority: "normal",
        timestamp: new Date(Date.now() - 3600000),
        isRead: true,
        readAt: new Date(Date.now() - 3500000)
      },
      {
        fromCode: "SP001",
        toTeamId: 1,
        content: "Team meeting at 2 PM today",
        type: "broadcast",
        priority: "high",
        timestamp: new Date(Date.now() - 1800000),
        isRead: false
      },
      {
        fromCode: "SP002",
        toCode: "AG005",
        content: "Please check the technical queue",
        type: "direct",
        priority: "normal",
        timestamp: new Date(Date.now() - 900000),
        isRead: false
      },
      {
        fromCode: "SP002",
        toCode: "AG006",
        content: "Great job on handling that complex case!",
        type: "direct",
        priority: "normal",
        timestamp: new Date(Date.now() - 5400000),
        isRead: true,
        readAt: new Date(Date.now() - 5300000)
      },
      {
        fromCode: "SP003",
        toTeamId: 3,
        content: "Great sales numbers this week!",
        type: "broadcast",
        priority: "normal",
        timestamp: new Date(Date.now() - 7200000),
        isRead: true
      },
      {
        fromCode: "SP003",
        toCode: "AG008",
        content: "Can you follow up with client ABC?",
        type: "direct",
        priority: "high",
        timestamp: new Date(Date.now() - 600000),
        isRead: false
      }
    ];
    await Message.insertMany(sampleMessages);

    console.log('📊 Inserting sample status logs...');
    const sampleStatusLogs = [
      // AG001 status changes
      {
        agentCode: "AG001",
        status: "Available",
        timestamp: new Date(Date.now() - 7200000),
        teamId: 1,
        duration: 3600
      },
      {
        agentCode: "AG001",
        status: "Busy",
        timestamp: new Date(Date.now() - 3600000),
        teamId: 1,
        duration: 1800
      },
      // AG002 status changes
      {
        agentCode: "AG002",
        status: "Available",
        timestamp: new Date(Date.now() - 14400000),
        teamId: 1,
        duration: 7200
      },
      {
        agentCode: "AG002",
        status: "Break",
        timestamp: new Date(Date.now() - 7200000),
        teamId: 1,
        duration: 900
      },
      // AG003 status changes
      {
        agentCode: "AG003",
        status: "Available",
        timestamp: new Date(Date.now() - 10800000),
        teamId: 1,
        duration: 5400
      },
      // AG005 status changes
      {
        agentCode: "AG005",
        status: "Busy",
        timestamp: new Date(Date.now() - 1800000),
        teamId: 2,
        duration: 1500
      },
      // AG006 status changes
      {
        agentCode: "AG006",
        status: "Available",
        timestamp: new Date(Date.now() - 9000000),
        teamId: 2,
        duration: 4500
      },
      // AG008 status changes
      {
        agentCode: "AG008",
        status: "Busy",
        timestamp: new Date(Date.now() - 3600000),
        teamId: 3,
        duration: 2700
      },
      // AG009 status changes
      {
        agentCode: "AG009",
        status: "Available",
        timestamp: new Date(Date.now() - 7200000),
        teamId: 3,
        duration: 7200
      }
    ];
    await AgentStatus.insertMany(sampleStatusLogs);

    console.log('🔗 Inserting sample connection logs...');
    const sampleConnectionLogs = [
      // AG001 connections
      {
        agentCode: "AG001",
        eventType: "connect",
        timestamp: new Date(Date.now() - 28800000),
        socketId: "socket_ag001_001",
        ipAddress: "192.168.1.100",
        userAgent: "Agent Desktop App v1.0"
      },
      {
        agentCode: "AG001",
        eventType: "disconnect",
        timestamp: new Date(Date.now() - 3600000),
        socketId: "socket_ag001_001",
        connectionDuration: 25200
      },
      // AG002 connections
      {
        agentCode: "AG002",
        eventType: "connect",
        timestamp: new Date(Date.now() - 14400000),
        socketId: "socket_ag002_001",
        ipAddress: "192.168.1.101",
        userAgent: "Agent Desktop App v1.0"
      },
      // AG003 connections
      {
        agentCode: "AG003",
        eventType: "connect",
        timestamp: new Date(Date.now() - 10800000),
        socketId: "socket_ag003_001",
        ipAddress: "192.168.1.102",
        userAgent: "Agent Desktop App v1.0"
      },
      // AG005 connections
      {
        agentCode: "AG005",
        eventType: "connect",
        timestamp: new Date(Date.now() - 7200000),
        socketId: "socket_ag005_001",
        ipAddress: "192.168.1.105",
        userAgent: "Agent Desktop App v1.0"
      },
      // AG006 connections
      {
        agentCode: "AG006",
        eventType: "connect",
        timestamp: new Date(Date.now() - 9000000),
        socketId: "socket_ag006_001",
        ipAddress: "192.168.1.106",
        userAgent: "Agent Desktop App v1.0"
      },
      {
        agentCode: "AG006",
        eventType: "disconnect",
        timestamp: new Date(Date.now() - 4500000),
        socketId: "socket_ag006_001",
        connectionDuration: 4500
      },
      // AG008 connections
      {
        agentCode: "AG008",
        eventType: "connect",
        timestamp: new Date(Date.now() - 5400000),
        socketId: "socket_ag008_001",
        ipAddress: "192.168.1.108",
        userAgent: "Agent Desktop App v1.0"
      }
    ];
    await ConnectionLog.insertMany(sampleConnectionLogs);

    // Verify
    const messageCount = await Message.countDocuments();
    const statusCount = await AgentStatus.countDocuments();
    const logCount = await ConnectionLog.countDocuments();

    console.log('✅ Sample data inserted successfully!');
    console.log('📊 Summary:');
    console.log(`   - Messages: ${messageCount} records`);
    console.log(`   - Status logs: ${statusCount} records`);
    console.log(`   - Connection logs: ${logCount} records`);

  } catch (error) {
    console.error('❌ Error inserting sample data:', error);
    throw error;
  }
}

// Main Setup Function with Error Handling
async function setupMongoDB() {
  let retries = 3;
  
  while (retries > 0) {
    try {
      console.log('🍃 Connecting to MongoDB...');
      await mongoose.connect(MONGODB_URI);
      console.log('✅ Connected to MongoDB');

      await insertSampleData();
      
      console.log('🚀 MongoDB setup completed!');
      return;
      
    } catch (error) {
      retries--;
      console.error(`❌ MongoDB setup failed: ${error.message}`);
      
      if (retries > 0) {
        console.log(`⚠️  Retrying... (${retries} attempts left)`);
        await new Promise(resolve => setTimeout(resolve, 3000));
      } else {
        console.error('❌ All retry attempts failed');
        throw error;
      }
    } finally {
      if (mongoose.connection.readyState === 1) {
        await mongoose.disconnect();
      }
    }
  }
}

// Run if called directly
if (require.main === module) {
  setupMongoDB().catch(error => {
    console.error('Fatal error:', error);
    process.exit(1);
  });
}

module.exports = { setupMongoDB, insertSampleData };
```

**3.2 สร้าง Setup Script `database/mongodb/setup.sh`:**
```bash
#!/bin/bash

echo "🍃 Setting up MongoDB..."

# Check if MongoDB is running
if ! mongosh --eval "db.adminCommand('ping')" >/dev/null 2>&1; then
    echo "❌ MongoDB is not running. Please start MongoDB first."
    echo ""
    echo "Start MongoDB:"
    echo "  Windows: net start MongoDB"
    echo "  macOS: brew services start mongodb-community"
    echo "  Linux: sudo systemctl start mongod"
    exit 1
fi

echo "✅ MongoDB is running"

# Install dependencies
if [ ! -d "node_modules" ]; then
    echo "📦 Installing dependencies..."
    npm install mongoose
fi

# Run sample data script
echo "📊 Creating collections and inserting sample data..."
node sample_data.js

if [ $? -ne 0 ]; then
    echo "❌ Failed to setup MongoDB"
    exit 1
fi

echo ""
echo "🔍 Verify with:"
echo "   mongosh wallboard --eval 'show collections'"
echo "   mongosh wallboard --eval 'db.messages.countDocuments()'"
```

**3.3 รัน Setup (Linux/Mac):**
```bash
cd database/mongodb
chmod +x setup.sh
./setup.sh
```

**3.4 รัน Setup (Windows):**
```powershell
cd database\mongodb
npm install mongoose
node sample_data.js
```

---

## ✅ Database Verification

### 🔍 SQLite Verification

**ตรวจสอบข้อมูลด้วย Command Line:**
```bash
cd database/sqlite

# 1. ตรวจสอบจำนวน records
sqlite3 wallboard.db "SELECT COUNT(*) FROM agents;"
# Expected: 13

sqlite3 wallboard.db "SELECT COUNT(*) FROM teams;"
# Expected: 3

# 2. ดูข้อมูล agents ทั้งหมด
sqlite3 wallboard.db "SELECT agent_code, agent_name, role FROM agents ORDER BY role DESC, agent_name;"

# 3. ดูโครงสร้างทีม
sqlite3 wallboard.db "
SELECT 
    t.team_name,
    COUNT(CASE WHEN a.role='agent' THEN 1 END) as agents
FROM teams t
LEFT JOIN agents a ON t.team_id = a.team_id
GROUP BY t.team_id;
"
```

**ตรวจสอบด้วย SQLite Browser:**
1. ดาวน์โหลด [DB Browser for SQLite](https://sqlitebrowser.org/)
2. เปิดไฟล์ `database/sqlite/wallboard.db`
3. ตรวจสอบ:
   - Table `teams` มี 3 records
   - Table `agents` มี 13 records
   - Table `system_config` มี 8 records

---

### 🔍 MongoDB Verification

**ตรวจสอบด้วย mongosh:**
```bash
# เข้าสู่ MongoDB Shell
mongosh wallboard

# 1. ดู collections ทั้งหมด
show collections
# Expected: messages, agent_status, connection_logs

# 2. นับจำนวน documents
db.messages.countDocuments()
# Expected: 4+

db.agent_status.countDocuments()
# Expected: 4+

db.connection_logs.countDocuments()
# Expected: 3+

# 3. ดูข้อมูลตัวอย่าง
db.messages.find().limit(3).pretty()

db.agent_status.find().sort({timestamp: -1}).limit(3).pretty()

# 4. ตรวจสอบ indexes
db.messages.getIndexes()
db.agent_status.getIndexes()
```

**ตรวจสอบด้วย MongoDB Compass:**
1. ดาวน์โหลด [MongoDB Compass](https://www.mongodb.com/products/compass)
2. เชื่อมต่อ: `mongodb://localhost:27017`
3. เลือก database `wallboard`
4. ตรวจสอบ collections และข้อมูล

---

## 🧪 Testing Queries

### 📊 SQLite - Useful Queries

```sql
-- 1. Login Verification (ทดสอบ Authentication)
SELECT agent_code, agent_name, team_id, role 
FROM agents 
WHERE agent_code = 'AG001' AND is_active = 1;

-- 2. Get Team Members (ทดสอบ Supervisor Dashboard)
SELECT a.agent_code, a.agent_name, a.email
FROM agents a
WHERE a.team_id = 1 AND a.role = 'agent' AND a.is_active = 1
ORDER BY a.agent_name;

-- 3. Get Supervisor Info
SELECT a.agent_code, a.agent_name, t.team_name
FROM agents a
JOIN teams t ON a.team_id = t.team_id
WHERE a.agent_code = 'SP001';

-- 4. System Configuration
SELECT config_key, config_value, description
FROM system_config
WHERE is_active = 1
ORDER BY config_key;

-- 5. Team Statistics
SELECT 
    t.team_name,
    t.supervisor_code,
    COUNT(a.agent_id) as total_agents
FROM teams t
LEFT JOIN agents a ON t.team_id = a.team_id AND a.role = 'agent'
WHERE t.is_active = 1
GROUP BY t.team_id
ORDER BY t.team_name;
```

---

### 🍃 MongoDB - Useful Queries

```javascript
// 1. Get Messages for Agent
db.messages.find({
  $or: [
    { toCode: "AG001" },
    { toTeamId: 1 }
  ]
}).sort({ timestamp: -1 }).limit(10);

// 2. Get Unread Messages
db.messages.find({
  toCode: "AG001",
  isRead: false
}).sort({ timestamp: -1 });

// 3. Get Agent Status History
db.agent_status.find({
  agentCode: "AG001"
}).sort({ timestamp: -1 }).limit(10);

// 4. Get Current Status
db.agent_status.find({
  agentCode: "AG001"
}).sort({ timestamp: -1 }).limit(1);

// 5. Get Connection Activity
db.connection_logs.find({
  agentCode: "AG001"
}).sort({ timestamp: -1 }).limit(5);

// 6. Team Status Summary
db.agent_status.aggregate([
  {
    $match: {
      teamId: 1,
      timestamp: { 
        $gte: new Date(Date.now() - 86400000) // Last 24 hours
      }
    }
  },
  {
    $group: {
      _id: "$agentCode",
      currentStatus: { $last: "$status" },
      lastUpdate: { $last: "$timestamp" }
    }
  }
]);

// 7. Message Statistics
db.messages.aggregate([
  {
    $group: {
      _id: "$type",
      count: { $sum: 1 },
      unread: { 
        $sum: { $cond: [{ $eq: ["$isRead", false] }, 1, 0] }
      }
    }
  }
]);
```

---

## 🔄 Data Relationship Diagram

```
┌─────────────────────────────────────────────────┐
│              SQLite (Master Data)                │
├─────────────────────────────────────────────────┤
│                                                  │
│  ┌──────────┐         ┌────────────────────┐   │
│  │  teams   │←─────┬──│     agents         │   │
│  │          │      │  │                    │   │
│  │ team_id  │      │  │ agent_code (PK)    │   │
│  │ team_name│      │  │ agent_name         │   │
│  │ supervisor_code  │  │ team_id (FK)       │   │
│  └──────────┘      │  │ role               │   │
│                    │  │ (agent/supervisor) │   │
│                    └──└────────────────────┘   │
│                                                  │
│  ┌─────────────────┐                            │
│  │ system_config   │                            │
│  │                 │                            │
│  │ config_key (PK) │                            │
│  │ config_value    │                            │
│  └─────────────────┘                            │
└─────────────────────────────────────────────────┘
                        ↓
                   agent_code
                        ↓
┌─────────────────────────────────────────────────┐
│             MongoDB (Real-time Data)             │
├─────────────────────────────────────────────────┤
│                                                  │
│  ┌─────────────────┐  ┌──────────────────────┐ │
│  │   messages      │  │   agent_status       │ │
│  │                 │  │                      │ │
│  │ fromCode        │  │ agentCode            │ │
│  │ toCode          │  │ status               │ │
│  │ toTeamId        │  │ timestamp            │ │
│  │ content         │  │ teamId               │ │
│  │ type            │  └──────────────────────┘ │
│  │ timestamp       │                           │
│  └─────────────────┘  ┌──────────────────────┐ │
│                       │  connection_logs     │ │
│                       │                      │ │
│                       │ agentCode            │ │
│                       │ eventType            │ │
│                       │ timestamp            │ │
│                       │ socketId             │ │
│                       └──────────────────────┘ │
│                                                  │
└─────────────────────────────────────────────────┘
```

---

## 🛠️ Maintenance Scripts

### 🧹 Reset Database Script

สร้างไฟล์ `database/reset_all.sh`:
```bash
#!/bin/bash

echo "⚠️  This will DELETE all data and reset to initial state!"
echo "Continue? (yes/no)"
read -r response

if [ "$response" != "yes" ]; then
    echo "❌ Reset cancelled"
    exit 0
fi

echo ""
echo "🧹 Resetting databases..."

# Reset SQLite
echo "📊 Resetting SQLite..."
cd sqlite
./setup.sh
cd ..

# Reset MongoDB
echo "🍃 Resetting MongoDB..."
mongosh wallboard --eval "db.dropDatabase()" --quiet
cd mongodb
node sample_data.js
cd ..

echo ""
echo "✅ Databases reset completed!"
echo ""
echo "🔍 Verify:"
echo "   SQLite: sqlite3 sqlite/wallboard.db 'SELECT COUNT(*) FROM agents;'"
echo "   MongoDB: mongosh wallboard --eval 'db.messages.countDocuments()'"
```

### 💾 Backup Script

สร้างไฟล์ `database/backup.sh`:
```bash
#!/bin/bash

BACKUP_DIR="backups/$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"

echo "💾 Creating backup..."

# Backup SQLite
echo "📊 Backing up SQLite..."
cp sqlite/wallboard.db "$BACKUP_DIR/"

# Backup MongoDB
echo "🍃 Backing up MongoDB..."
mongodump --db wallboard --out "$BACKUP_DIR/mongodb" --quiet

echo ""
echo "✅ Backup completed!"
echo "📁 Location: $BACKUP_DIR"
echo ""
ls -lh "$BACKUP_DIR"
```

---

## 📝 Sample Login Credentials

### 👨‍💼 Supervisors (สำหรับทดสอบ Supervisor Dashboard)

```
SP001 - Sarah Wilson (Customer Service Team)
SP002 - Mike Johnson (Technical Support Team)
SP003 - Lisa Chen (Sales Team)
```

### 👥 Agents (สำหรับทดสอบ Agent Desktop App)

**Customer Service Team (Team ID: 1):**
```
AG001 - John Smith
AG002 - Emma Davis
AG003 - Robert Brown
AG004 - Jennifer Wilson
```

**Technical Support Team (Team ID: 2):**
```
AG005 - David Miller
AG006 - Amanda Taylor
AG007 - Chris Anderson
```

**Sales Team (Team ID: 3):**
```
AG008 - Michelle Garcia
AG009 - Kevin Martinez
AG010 - Jessica Rodriguez
```

---

## 🎯 Testing Scenarios

### Scenario 1: Agent Login และ Status Update

```bash
# 1. Agent Login (ใช้ SQLite)
SELECT * FROM agents WHERE agent_code = 'AG001';

# 2. Status Update (บันทึกลง MongoDB)
# Agent เปลี่ยนสถานะเป็น "Available"
db.agent_status.insertOne({
  agentCode: "AG001",
  status: "Available",
  timestamp: new Date(),
  teamId: 1
});

# 3. ตรวจสอบ Status ปัจจุบัน
db.agent_status.find({ agentCode: "AG001" })
  .sort({ timestamp: -1 })
  .limit(1);
```

### Scenario 2: Supervisor ส่งข้อความ

```bash
# 1. Supervisor Login (ใช้ SQLite)
SELECT a.*, t.team_name 
FROM agents a
JOIN teams t ON a.team_id = t.team_id
WHERE a.agent_code = 'SP001';

# 2. ดูรายชื่อ Team Members
SELECT agent_code, agent_name 
FROM agents 
WHERE team_id = 1 AND role = 'agent';

# 3. ส่งข้อความ Direct (บันทึกลง MongoDB)
db.messages.insertOne({
  fromCode: "SP001",
  toCode: "AG001",
  content: "Please check your queue",
  type: "direct",
  priority: "normal",
  timestamp: new Date(),
  isRead: false
});

# 4. Agent อ่านข้อความ
db.messages.find({ toCode: "AG001", isRead: false })
  .sort({ timestamp: -1 });
```

### Scenario 3: Broadcast Message

```bash
# 1. Supervisor ส่ง Broadcast ไปทั้งทีม
db.messages.insertOne({
  fromCode: "SP001",
  toTeamId: 1,
  content: "Team meeting at 2 PM",
  type: "broadcast",
  priority: "high",
  timestamp: new Date(),
  isRead: false
});

# 2. Agents ในทีมอ่านข้อความ
# (ใช้ team_id จาก SQLite + toTeamId จาก MongoDB)
db.messages.find({ toTeamId: 1, type: "broadcast" })
  .sort({ timestamp: -1 });
```

---

## 🚨 Troubleshooting

### ❌ SQLite Issues

**Problem: "unable to open database file"**
```bash
# Solution: ตรวจสอบ path และ permissions
ls -l database/sqlite/wallboard.db
chmod 644 database/sqlite/wallboard.db
```

**Problem: "FOREIGN KEY constraint failed"**
```bash
# Solution: ตรวจสอบ foreign key constraints
sqlite3 wallboard.db "PRAGMA foreign_keys = ON;"
sqlite3 wallboard.db "PRAGMA foreign_key_check;"
```

**Problem: "table already exists"**
```bash
# Solution: ลบ database แล้วสร้างใหม่
rm database/sqlite/wallboard.db
cd database/sqlite && ./setup.sh
```

---

### ❌ MongoDB Issues

**Problem: "MongoServerError: connect ECONNREFUSED"**
```bash
# Solution: เริ่ม MongoDB service
# Windows
net start MongoDB

# macOS
brew services start mongodb-community

# Linux
sudo systemctl start mongod
```

**Problem: "Database not found"**
```bash
# Solution: รัน sample data script ใหม่
cd database/mongodb
node sample_data.js
```

**Problem: "Cannot find module 'mongoose'"**
```bash
# Solution: ติดตั้ง dependencies
cd database/mongodb
npm install mongoose
```

---

## ✅ Verification Checklist

### 📋 SQLite Verification
- [ ] ไฟล์ `wallboard.db` อยู่ใน `database/sqlite/`
- [ ] Table `teams` มี 3 records
- [ ] Table `agents` มี 13 records (3 supervisors + 10 agents)
- [ ] Table `system_config` มี 8 records
- [ ] Foreign keys ทำงานได้ (team_id references)
- [ ] Indexes ถูกสร้างแล้ว
- [ ] สามารถ query ได้ปกติ

### 📋 MongoDB Verification
- [ ] MongoDB service กำลังทำงาน
- [ ] Database `wallboard` ถูกสร้างแล้ว
- [ ] Collection `messages` มีข้อมูล (4+ documents)
- [ ] Collection `agent_status` มีข้อมูล (4+ documents)
- [ ] Collection `connection_logs` มีข้อมูล (3+ documents)
- [ ] Indexes ถูกสร้างแล้ว
- [ ] สามารถ query ได้ปกติ

### 📋 Integration Verification
- [ ] Agent codes ใน SQLite ตรงกับ MongoDB
- [ ] Team IDs สอดคล้องกันทั้งสองระบบ
- [ ] Sample login credentials ใช้งานได้
- [ ] Relationships ถูกต้อง (teams ↔ agents)

---

## 🎉 สรุป

### ความเข้าใจที่ได้รับ:

**📊 SQLite:**
- เก็บข้อมูลหลักที่ไม่เปลี่ยนบ่อย
- 3 tables สำคัญ: teams, agents, system_config
- 13 sample users พร้อมใช้งาน
- Foreign keys รักษาความสัมพันธ์ของข้อมูล

**🍃 MongoDB:**
- เก็บข้อมูล real-time ที่เปลี่ยนบ่อย
- 3 collections: messages, agent_status, connection_logs
- Flexible schema รองรับการเปลี่ยนแปลง
- Indexes เพื่อ performance

**🔗 Integration:**
- ใช้ `agent_code` เป็น key เชื่อมโยงทั้งสองระบบ
- SQLite เก็บ "WHO" (agents, teams)
- MongoDB เก็บ "WHAT/WHEN" (messages, status, logs)

---

## 📚 Next Steps

หลังจาก setup databases เรียบร้อยแล้ว:

1. ✅ **Database พร้อมใช้งาน**
2. ⏭️ **[6.6.2 Backend Server Code](./6.6.2-Backend-Server-Code-Guide.md)** - เรียนรู้วิธีใช้ databases ในโค้ด
3. ⏭️ **[6.6.3 Frontend Applications](./6.6.3.1-Frontend-Applications-Electron-Agent-App.md)** - เชื่อมต่อ UI กับ backend

**🚀 Databases พร้อมแล้ว! ต่อไป: Backend Development**