# 6.6.2 Backend Server Code Guide - Agent Wallboard System

## üéØ ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°

‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Backend Server ‡∏Ç‡∏≠‡∏á Agent Wallboard System ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ **Node.js + Express + Socket.io** ‡πÇ‡∏î‡∏¢‡πÄ‡∏ô‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á

### üéì ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ
‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏à‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ:
- ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Node.js Backend ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á 85%
- ‡∏£‡∏π‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ API endpoints ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ
- ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á WebSocket ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö real-time communication
- ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° features ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ

---

## üèóÔ∏è **Backend Architecture Overview**

### **üìÅ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç**
```
backend-server/
‚îú‚îÄ‚îÄ üöÄ server.js                    # Entry point - ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á (85% complete)
‚îú‚îÄ‚îÄ üì¶ package.json                 # Dependencies ‡πÅ‡∏•‡∏∞ scripts
‚îú‚îÄ‚îÄ üîß .env.example                 # Environment variables template
‚îÇ
‚îú‚îÄ‚îÄ ‚öôÔ∏è config/
‚îÇ   ‚îî‚îÄ‚îÄ üóÑÔ∏è database.js             # Database connections (90% complete)
‚îÇ
‚îú‚îÄ‚îÄ üõ£Ô∏è routes/                      # API endpoints (85% complete)
‚îÇ   ‚îú‚îÄ‚îÄ üîê auth.js                  # Authentication APIs
‚îÇ   ‚îú‚îÄ‚îÄ üë• agents.js                # Agent management APIs
‚îÇ   ‚îî‚îÄ‚îÄ üí¨ messages.js              # Message handling APIs
‚îÇ
‚îú‚îÄ‚îÄ üß† models/                      # Database models (90% complete)
‚îÇ   ‚îú‚îÄ‚îÄ üìÑ Agent.js                 # SQLite agent model
‚îÇ   ‚îú‚îÄ‚îÄ üí¨ Message.js               # MongoDB message model
‚îÇ   ‚îî‚îÄ‚îÄ üìä Status.js                # MongoDB status model
‚îÇ
‚îú‚îÄ‚îÄ üîå socket/                      # WebSocket handlers (75% complete)
‚îÇ   ‚îú‚îÄ‚îÄ ‚ö° socketHandler.js         # Main WebSocket event handling
‚îÇ   ‚îú‚îÄ‚îÄ üì° statusEvents.js          # Status change events
‚îÇ   ‚îî‚îÄ‚îÄ üí¨ messageEvents.js         # Message sending/receiving events
‚îÇ
‚îú‚îÄ‚îÄ üõ°Ô∏è middleware/                  # Middleware functions (95% complete)
‚îÇ   ‚îú‚îÄ‚îÄ üîê auth.js                  # JWT authentication middleware
‚îÇ   ‚îú‚îÄ‚îÄ üåê cors.js                  # CORS configuration
‚îÇ   ‚îî‚îÄ‚îÄ ‚ùå errorHandler.js          # Error handling middleware
‚îÇ
‚îî‚îÄ‚îÄ üß™ test/                        # Basic API tests (optional)
    ‚îú‚îÄ‚îÄ üîê auth.test.js             # Authentication tests
    ‚îî‚îÄ‚îÄ üí¨ messages.test.js         # Message API tests
```

### **üîÑ Request Flow Diagram**
```
üì± Client Request
    ‚Üì
üõ°Ô∏è CORS Middleware
    ‚Üì
üîê Authentication Middleware (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
    ‚Üì
üõ£Ô∏è Route Handler (auth.js, agents.js, messages.js)
    ‚Üì
üß† Database Model (Agent.js, Message.js)
    ‚Üì
üóÑÔ∏è Database (SQLite/MongoDB)
    ‚Üì
üì® JSON Response
```

---

## üöÄ **Main Server File - server.js**

### **üéØ ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å:**
- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Express server
- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ WebSocket server
- ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ databases
- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ middleware ‡πÅ‡∏•‡∏∞ routes

### **üìã Code Walkthrough:**
```javascript
// ========== DEPENDENCIES ==========
const express = require('express');
const http = require('http');
const socketio = require('socket.io');
const cors = require('cors');
require('dotenv').config();

// ========== IMPORTS ==========
// Import route handlers
const authRoutes = require('./routes/auth');
const agentRoutes = require('./routes/agents');
const messageRoutes = require('./routes/messages');

// Import WebSocket handler
const socketHandler = require('./socket/socketHandler');

// Import database configuration
const { connectMongoDB, initSQLite } = require('./config/database');

// ========== EXPRESS APP SETUP ==========
const app = express();
const server = http.createServer(app);

// ========== MIDDLEWARE SETUP ==========
app.use(cors({
  origin: ['http://localhost:3000', 'http://localhost:3001'],
  credentials: true
}));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// ========== ROUTES SETUP ==========
app.use('/api/auth', authRoutes);
app.use('/api/agents', agentRoutes);
app.use('/api/messages', messageRoutes);

// Health check endpoint
app.get('/health', (req, res) => {
  res.json({ 
    status: 'OK', 
    timestamp: new Date().toISOString(),
    uptime: process.uptime()
  });
});

// ========== WEBSOCKET SETUP ==========
const io = socketio(server, {
  cors: {
    origin: ['http://localhost:3000', 'http://localhost:3001'],
    methods: ['GET', 'POST']
  }
});

// Initialize WebSocket handler
socketHandler(io);

// ========== DATABASE INITIALIZATION ==========
async function initializeDatabases() {
  try {
    await initSQLite();
    console.log('‚úÖ SQLite database initialized');
    
    await connectMongoDB();
    console.log('‚úÖ MongoDB connected');
  } catch (error) {
    console.error('‚ùå Database initialization failed:', error);
    process.exit(1);
  }
}

// ========== SERVER START ==========
const PORT = process.env.PORT || 3001;

initializeDatabases().then(() => {
  server.listen(PORT, () => {
    console.log(`üöÄ Backend server running on port ${PORT}`);
    console.log(`üìä Health check: http://localhost:${PORT}/health`);
    console.log(`‚ö° WebSocket server ready`);
  });
});

module.exports = app;
```

---

## üõ£Ô∏è **API Routes Structure**

### **üîê Authentication Routes - routes/auth.js**

**üéØ ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà:** ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£ login/logout ‡πÅ‡∏•‡∏∞ authentication

```javascript
const express = require('express');
const jwt = require('jsonwebtoken');
const router = express.Router();
const Agent = require('../models/Agent');

// ========== AGENT/SUPERVISOR LOGIN ==========
router.post('/login', async (req, res) => {
  try {
    const { agentCode, supervisorCode, type } = req.body;
    
    // Determine login type
    const isAgent = agentCode && !supervisorCode;
    const isSupervisor = supervisorCode && !agentCode;
    
    if (!isAgent && !isSupervisor) {
      return res.status(400).json({
        success: false,
        error: 'Must provide either agentCode or supervisorCode'
      });
    }
    
    let user;
    
    if (isAgent) {
      // Agent login
      user = await Agent.findByCode(agentCode.toUpperCase());
      if (!user || user.role !== 'agent') {
        return res.status(401).json({
          success: false,
          error: 'Invalid agent code'
        });
      }
    } else {
      // Supervisor login
      user = await Agent.findByCode(supervisorCode.toUpperCase());
      if (!user || user.role !== 'supervisor') {
        return res.status(401).json({
          success: false,
          error: 'Invalid supervisor code'
        });
      }
      
      // Get team data for supervisor
      const teamData = await Agent.findByTeam(user.teamId);
      user.teamData = teamData;
    }
    
    // Generate JWT token
    const token = jwt.sign(
      { 
        userId: user.agentCode,
        role: user.role,
        teamId: user.teamId 
      },
      process.env.JWT_SECRET || 'default-secret',
      { expiresIn: '24h' }
    );
    
    res.json({
      success: true,
      data: {
        user: {
          agentCode: user.agentCode,
          agentName: user.agentName,
          teamId: user.teamId,
          teamName: user.teamName,
          role: user.role,
          ...(user.teamData && { teamData: user.teamData })
        },
        token
      }
    });
    
  } catch (error) {
    console.error('Login error:', error);
    res.status(500).json({
      success: false,
      error: 'Internal server error'
    });
  }
});

// ========== LOGOUT ==========
router.post('/logout', (req, res) => {
  // In a real app, you might invalidate the JWT token here
  res.json({
    success: true,
    message: 'Logged out successfully'
  });
});

module.exports = router;
```

### **üë• Agent Management Routes - routes/agents.js**

**üéØ ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà:** ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• agents ‡πÅ‡∏•‡∏∞ status updates

```javascript
const express = require('express');
const router = express.Router();
const Agent = require('../models/Agent');
const Status = require('../models/Status');
const authMiddleware = require('../middleware/auth');

// ========== GET TEAM AGENTS (for supervisors) ==========
router.get('/team/:teamId', authMiddleware, async (req, res) => {
  try {
    const { teamId } = req.params;
    
    const agents = await Agent.findByTeam(parseInt(teamId));
    
    res.json({
      success: true,
      teamId: parseInt(teamId),
      agents: agents,
      count: agents.length
    });
    
  } catch (error) {
    console.error('Get team agents error:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to get team agents'
    });
  }
});

// ========== UPDATE AGENT STATUS ==========
router.put('/:agentCode/status', authMiddleware, async (req, res) => {
  try {
    const { agentCode } = req.params;
    const { status } = req.body;
    
    // Validate status
    const validStatuses = ['Available', 'Busy', 'Break', 'Offline'];
    if (!validStatuses.includes(status)) {
      return res.status(400).json({
        success: false,
        error: 'Invalid status. Must be: ' + validStatuses.join(', ')
      });
    }
    
    // Verify agent exists
    const agent = await Agent.findByCode(agentCode.toUpperCase());
    if (!agent) {
      return res.status(404).json({
        success: false,
        error: 'Agent not found'
      });
    }
    
    // Save status to MongoDB
    const statusUpdate = await Status.create({
      agentCode: agentCode.toUpperCase(),
      status: status,
      timestamp: new Date(),
      teamId: agent.teamId
    });
    
    res.json({
      success: true,
      data: {
        agentCode: agentCode.toUpperCase(),
        currentStatus: status,
        timestamp: statusUpdate.timestamp,
        teamId: agent.teamId
      }
    });
    
  } catch (error) {
    console.error('Update status error:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to update status'
    });
  }
});

// ========== GET AGENT HISTORY ==========
router.get('/:agentCode/history', authMiddleware, async (req, res) => {
  try {
    const { agentCode } = req.params;
    const { limit = 50 } = req.query;
    
    const history = await Status.find({ 
      agentCode: agentCode.toUpperCase() 
    })
    .sort({ timestamp: -1 })
    .limit(parseInt(limit))
    .lean();
    
    res.json({
      success: true,
      agentCode: agentCode.toUpperCase(),
      history: history,
      count: history.length
    });
    
  } catch (error) {
    console.error('Get agent history error:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to get agent history'
    });
  }
});

module.exports = router;
```

### **üí¨ Message Routes - routes/messages.js**

**üéØ ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà:** ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°

```javascript
const express = require('express');
const router = express.Router();
const Message = require('../models/Message');
const Agent = require('../models/Agent');
const authMiddleware = require('../middleware/auth');

// ========== SEND MESSAGE ==========
router.post('/send', authMiddleware, async (req, res) => {
  try {
    const { fromCode, toCode, toTeamId, content, type, priority } = req.body;
    
    // Validate required fields
    if (!fromCode || !content || !type) {
      return res.status(400).json({
        success: false,
        error: 'fromCode, content, and type are required'
      });
    }
    
    // Validate message type
    if (!['direct', 'broadcast'].includes(type)) {
      return res.status(400).json({
        success: false,
        error: 'type must be either "direct" or "broadcast"'
      });
    }
    
    // For direct messages, validate recipient
    if (type === 'direct' && !toCode) {
      return res.status(400).json({
        success: false,
        error: 'toCode is required for direct messages'
      });
    }
    
    // For broadcast messages, validate team
    if (type === 'broadcast' && !toTeamId) {
      return res.status(400).json({
        success: false,
        error: 'toTeamId is required for broadcast messages'
      });
    }
    
    // Create message
    const messageData = {
      fromCode: fromCode.toUpperCase(),
      content: content,
      type: type,
      priority: priority || 'normal',
      timestamp: new Date(),
      isRead: false
    };
    
    if (type === 'direct') {
      messageData.toCode = toCode.toUpperCase();
    } else {
      messageData.toTeamId = parseInt(toTeamId);
    }
    
    const message = await Message.create(messageData);
    
    res.json({
      success: true,
      data: {
        messageId: message._id,
        fromCode: message.fromCode,
        type: message.type,
        timestamp: message.timestamp,
        ...(message.toCode && { toCode: message.toCode }),
        ...(message.toTeamId && { toTeamId: message.toTeamId })
      }
    });
    
  } catch (error) {
    console.error('Send message error:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to send message'
    });
  }
});

// ========== GET MESSAGES FOR AGENT ==========
router.get('/agent/:agentCode', authMiddleware, async (req, res) => {
  try {
    const { agentCode } = req.params;
    const { limit = 50, unreadOnly = false } = req.query;
    
    // Get agent info for team
    const agent = await Agent.findByCode(agentCode.toUpperCase());
    if (!agent) {
      return res.status(404).json({
        success: false,
        error: 'Agent not found'
      });
    }
    
    // Build query
    const query = {
      $or: [
        { toCode: agentCode.toUpperCase() }, // Direct messages
        { toTeamId: agent.teamId }           // Broadcast messages
      ]
    };
    
    if (unreadOnly === 'true') {
      query.isRead = false;
    }
    
    const messages = await Message.find(query)
      .sort({ timestamp: -1 })
      .limit(parseInt(limit))
      .lean();
    
    res.json({
      success: true,
      agentCode: agentCode.toUpperCase(),
      messages: messages,
      count: messages.length
    });
    
  } catch (error) {
    console.error('Get agent messages error:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to get messages'
    });
  }
});

// ========== MARK MESSAGE AS READ ==========
router.put('/:messageId/read', authMiddleware, async (req, res) => {
  try {
    const { messageId } = req.params;
    
    const message = await Message.findByIdAndUpdate(
      messageId,
      { isRead: true, readAt: new Date() },
      { new: true }
    );
    
    if (!message) {
      return res.status(404).json({
        success: false,
        error: 'Message not found'
      });
    }
    
    res.json({
      success: true,
      data: {
        messageId: message._id,
        isRead: message.isRead,
        readAt: message.readAt
      }
    });
    
  } catch (error) {
    console.error('Mark message read error:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to mark message as read'
    });
  }
});

// ========== GET MESSAGE HISTORY (for supervisors) ==========
router.get('/history/:fromCode', authMiddleware, async (req, res) => {
  try {
    const { fromCode } = req.params;
    const { limit = 100 } = req.query;
    
    const messages = await Message.find({
      fromCode: fromCode.toUpperCase()
    })
    .sort({ timestamp: -1 })
    .limit(parseInt(limit))
    .lean();
    
    res.json({
      success: true,
      fromCode: fromCode.toUpperCase(),
      messages: messages,
      count: messages.length
    });
    
  } catch (error) {
    console.error('Get history error:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to get message history'
    });
  }
});

module.exports = router;
```

---

## ‚ö° **WebSocket Handler - socket/socketHandler.js**

### **üéØ ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å:**
- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ WebSocket connections
- Handle real-time events (status changes, messages)
- Broadcast updates ‡πÑ‡∏õ‡∏¢‡∏±‡∏á connected clients

### **üìã Code Walkthrough:**
```javascript
const Message = require('../models/Message');
const Status = require('../models/Status');

// Keep track of connected clients
const activeConnections = new Map(); // agentCode -> socketId
const supervisorConnections = new Map(); // supervisorCode -> socketId

function socketHandler(io) {
  console.log('‚ö° WebSocket server initialized');
  
  io.on('connection', (socket) => {
    console.log('üîå New client connected:', socket.id);
    
    // ========== AGENT CONNECTION ==========
    socket.on('agent_connect', (data) => {
      try {
        const { agentCode } = data;
        
        if (!agentCode) {
          socket.emit('connection_error', { message: 'Agent code required' });
          return;
        }
        
        const cleanAgentCode = agentCode.toUpperCase();
        
        // Store connection
        activeConnections.set(cleanAgentCode, socket.id);
        socket.agentCode = cleanAgentCode;
        socket.userType = 'agent';
        
        console.log(`üë§ Agent ${cleanAgentCode} connected`);
        
        // Notify supervisors that agent is online
        socket.broadcast.emit('agent_connected', {
          agentCode: cleanAgentCode,
          timestamp: new Date()
        });
        
        socket.emit('connection_success', {
          agentCode: cleanAgentCode,
          status: 'connected'
        });
        
      } catch (error) {
        console.error('Agent connect error:', error);
        socket.emit('connection_error', { message: 'Connection failed' });
      }
    });
    
    // ========== SUPERVISOR CONNECTION ==========
    socket.on('supervisor_connect', (data) => {
      try {
        const { supervisorCode } = data;
        
        if (!supervisorCode) {
          socket.emit('connection_error', { message: 'Supervisor code required' });
          return;
        }
        
        const cleanSupervisorCode = supervisorCode.toUpperCase();
        
        // Store connection
        supervisorConnections.set(cleanSupervisorCode, socket.id);
        socket.supervisorCode = cleanSupervisorCode;
        socket.userType = 'supervisor';
        
        console.log(`üë®‚Äçüíº Supervisor ${cleanSupervisorCode} connected`);
        
        socket.emit('connection_success', {
          supervisorCode: cleanSupervisorCode,
          status: 'connected'
        });
        
      } catch (error) {
        console.error('Supervisor connect error:', error);
        socket.emit('connection_error', { message: 'Connection failed' });
      }
    });
    
    // ========== STATUS UPDATE ==========
    socket.on('update_status', async (data) => {
      try {
        const { agentCode, status } = data;
        
        if (!agentCode || !status) {
          socket.emit('status_error', { message: 'agentCode and status required' });
          return;
        }
        
        // Save to database
        const statusUpdate = await Status.create({
          agentCode: agentCode.toUpperCase(),
          status: status,
          timestamp: new Date()
        });
        
        // Broadcast to all supervisors
        socket.broadcast.emit('agent_status_update', {
          agentCode: agentCode.toUpperCase(),
          status: status,
          timestamp: statusUpdate.timestamp
        });
        
        // Confirm to agent
        socket.emit('status_updated', {
          agentCode: agentCode.toUpperCase(),
          status: status,
          timestamp: statusUpdate.timestamp
        });
        
        console.log(`üìä ${agentCode} status updated to ${status}`);
        
      } catch (error) {
        console.error('Status update error:', error);
        socket.emit('status_error', { message: 'Failed to update status' });
      }
    });
    
    // ========== SEND MESSAGE ==========
    socket.on('send_message', async (data) => {
      try {
        const { fromCode, toCode, toTeamId, content, type } = data;
        
        // Save message to database
        const messageData = {
          fromCode: fromCode.toUpperCase(),
          content: content,
          type: type || 'direct',
          timestamp: new Date(),
          isRead: false
        };
        
        if (type === 'direct' && toCode) {
          messageData.toCode = toCode.toUpperCase();
        } else if (type === 'broadcast' && toTeamId) {
          messageData.toTeamId = parseInt(toTeamId);
        }
        
        const message = await Message.create(messageData);
        
        // Send to recipient(s)
        if (type === 'direct' && toCode) {
          // Send to specific agent
          const targetSocketId = activeConnections.get(toCode.toUpperCase());
          if (targetSocketId) {
            io.to(targetSocketId).emit('new_message', {
              messageId: message._id,
              fromCode: message.fromCode,
              content: message.content,
              timestamp: message.timestamp,
              type: 'direct'
            });
          }
        } else if (type === 'broadcast') {
          // Broadcast to all agents in team
          socket.broadcast.emit('new_message', {
            messageId: message._id,
            fromCode: message.fromCode,
            content: message.content,
            timestamp: message.timestamp,
            type: 'broadcast'
          });
        }
        
        // Confirm to sender
        socket.emit('message_sent', {
          messageId: message._id,
          status: 'delivered'
        });
        
        console.log(`üí¨ Message sent from ${fromCode} (${type})`);
        
      } catch (error) {
        console.error('Send message error:', error);
        socket.emit('message_error', { message: 'Failed to send message' });
      }
    });
    
    // ========== DISCONNECT HANDLING ==========
    socket.on('disconnect', () => {
      try {
        console.log(`üîå Client disconnected: ${socket.id}`);
        
        if (socket.agentCode) {
          activeConnections.delete(socket.agentCode);
          
          // Notify supervisors that agent is offline
          socket.broadcast.emit('agent_disconnected', {
            agentCode: socket.agentCode,
            timestamp: new Date()
          });
          
          console.log(`üë§ Agent ${socket.agentCode} disconnected`);
        }
        
        if (socket.supervisorCode) {
          supervisorConnections.delete(socket.supervisorCode);
          console.log(`üë®‚Äçüíº Supervisor ${socket.supervisorCode} disconnected`);
        }
        
      } catch (error) {
        console.error('Disconnect handling error:', error);
      }
    });
    
  });
}

module.exports = socketHandler;
```

---

## üß† **Database Models**

### **üìÑ Agent Model - models/Agent.js (SQLite)**

```javascript
const sqlite3 = require('sqlite3').verbose();
const path = require('path');

const DB_PATH = process.env.SQLITE_DB_PATH || '../database/sqlite/wallboard.db';

class Agent {
  static async findByCode(agentCode) {
    return new Promise((resolve, reject) => {
      const db = new sqlite3.Database(DB_PATH);
      
      const query = `
        SELECT a.*, t.team_name 
        FROM agents a 
        LEFT JOIN teams t ON a.team_id = t.team_id 
        WHERE a.agent_code = ? AND a.is_active = 1
      `;
      
      db.get(query, [agentCode], (err, row) => {
        if (err) {
          reject(err);
        } else {
          resolve(row || null);
        }
        db.close();
      });
    });
  }
  
  static async findByTeam(teamId) {
    return new Promise((resolve, reject) => {
      const db = new sqlite3.Database(DB_PATH);
      
      const query = `
        SELECT agent_code, agent_name, role, email, phone
        FROM agents 
        WHERE team_id = ? AND is_active = 1
        ORDER BY agent_name
      `;
      
      db.all(query, [teamId], (err, rows) => {
        if (err) {
          reject(err);
        } else {
          resolve(rows || []);
        }
        db.close();
      });
    });
  }
}

module.exports = Agent;
```

### **üí¨ Message Model - models/Message.js (MongoDB)**

```javascript
const mongoose = require('mongoose');

const messageSchema = new mongoose.Schema({
  fromCode: {
    type: String,
    required: true,
    uppercase: true
  },
  toCode: {
    type: String,
    uppercase: true
  },
  toTeamId: {
    type: Number
  },
  content: {
    type: String,
    required: true,
    trim: true
  },
  type: {
    type: String,
    enum: ['direct', 'broadcast'],
    required: true
  },
  priority: {
    type: String,
    enum: ['low', 'normal', 'high'],
    default: 'normal'
  },
  isRead: {
    type: Boolean,
    default: false
  },
  readAt: {
    type: Date
  },
  timestamp: {
    type: Date,
    default: Date.now,
    index: true
  }
}, {
  collection: 'messages',
  timestamps: true
});

// Indexes for performance
messageSchema.index({ toCode: 1, timestamp: -1 });
messageSchema.index({ toTeamId: 1, timestamp: -1 });
messageSchema.index({ fromCode: 1, timestamp: -1 });

module.exports = mongoose.model('Message', messageSchema);
```

### **üìä Status Model - models/Status.js (MongoDB)**

```javascript
const mongoose = require('mongoose');

const statusSchema = new mongoose.Schema({
  agentCode: {
    type: String,
    required: true,
    uppercase: true,
    index: true
  },
  status: {
    type: String,
    enum: ['Available', 'Busy', 'Break', 'Offline'],
    required: true
  },
  timestamp: {
    type: Date,
    default: Date.now,
    index: true
  },
  teamId: {
    type: Number,
    index: true
  }
}, {
  collection: 'agent_status',
  timestamps: true
});

// Compound index for efficient queries
statusSchema.index({ agentCode: 1, timestamp: -1 });
statusSchema.index({ teamId: 1, timestamp: -1 });

module.exports = mongoose.model('Status', statusSchema);
```

---

## üõ°Ô∏è **Middleware**

### **üîê Authentication Middleware - middleware/auth.js**

```javascript
const jwt = require('jsonwebtoken');

const authMiddleware = (req, res, next) => {
  try {
    // Get token from Authorization header
    const authHeader = req.headers.authorization;
    
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return res.status(401).json({
        success: false,
        error: 'No token provided'
      });
    }
    
    const token = authHeader.substring(7); // Remove 'Bearer ' prefix
    
    // Verify and decode token
    const decoded = jwt.verify(token, process.env.JWT_SECRET || 'default-secret');
    
    // Add user info to request object
    req.user = {
      userId: decoded.userId,
      role: decoded.role,
      teamId: decoded.teamId
    };
    
    next();
    
  } catch (error) {
    if (error.name === 'TokenExpiredError') {
      return res.status(401).json({
        success: false,
        error: 'Token expired'
      });
    }
    
    return res.status(401).json({
      success: false,
      error: 'Invalid token'
    });
  }
};

module.exports = authMiddleware;
```

### **‚ùå Error Handler Middleware - middleware/errorHandler.js**

```javascript
const errorHandler = (err, req, res, next) => {
  console.error('Error:', err);
  
  // Default error
  let error = {
    success: false,
    error: 'Internal server error'
  };
  
  // Mongoose validation error
  if (err.name === 'ValidationError') {
    const message = Object.values(err.errors).map(val => val.message).join(', ');
    error.error = message;
    return res.status(400).json(error);
  }
  
  // Mongoose duplicate key error
  if (err.code === 11000) {
    error.error = 'Duplicate field value entered';
    return res.status(400).json(error);
  }
  
  // JWT error
  if (err.name === 'JsonWebTokenError') {
    error.error = 'Invalid token';
    return res.status(401).json(error);
  }
  
  res.status(500).json(error);
};

module.exports = errorHandler;
```

---

## ‚öôÔ∏è **Database Configuration - config/database.js**

```javascript
const sqlite3 = require('sqlite3').verbose();
const mongoose = require('mongoose');
const path = require('path');

// ========== SQLITE CONFIGURATION ==========
const SQLITE_DB_PATH = process.env.SQLITE_DB_PATH || '../database/sqlite/wallboard.db';

const initSQLite = () => {
  return new Promise((resolve, reject) => {
    const db = new sqlite3.Database(SQLITE_DB_PATH, (err) => {
      if (err) {
        console.error('SQLite connection error:', err);
        reject(err);
      } else {
        console.log('‚úÖ Connected to SQLite database');
        resolve();
      }
      db.close();
    });
  });
};

// ========== MONGODB CONFIGURATION ==========
const MONGODB_URI = process.env.MONGODB_URI || 'mongodb://localhost:27017/wallboard';

const connectMongoDB = async () => {
  try {
    await mongoose.connect(MONGODB_URI);
    console.log('‚úÖ Connected to MongoDB');
  } catch (error) {
    console.error('MongoDB connection error:', error);
    throw error;
  }
};

module.exports = {
  initSQLite,
  connectMongoDB
};
```

---

## üì¶ **Package.json ‡πÅ‡∏•‡∏∞ Scripts**

### **üìã Dependencies ‡πÅ‡∏•‡∏∞ Scripts**

```json
{
  "name": "backend-server",
  "version": "1.0.0",
  "description": "Backend server for Agent Wallboard System",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js",
    "test": "jest",
    "test:api": "node test/api-test.js",
    "test:db": "node test/db-test.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "socket.io": "^4.7.2",
    "sqlite3": "^5.1.6",
    "mongoose": "^7.5.0",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1",
    "jsonwebtoken": "^9.0.2"
  },
  "devDependencies": {
    "nodemon": "^3.0.1",
    "jest": "^29.6.0"
  }
}
```

---

## üß™ **‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö Backend APIs**

### **üìã Postman Collection Example**

```json
{
  "info": {
    "name": "Agent Wallboard Backend APIs",
    "description": "Complete API collection for testing"
  },
  "item": [
    {
      "name": "Health Check",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/health",
          "host": ["{{baseUrl}}"],
          "path": ["health"]
        }
      }
    },
    {
      "name": "Agent Login",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"agentCode\": \"AG001\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/auth/login",
          "host": ["{{baseUrl}}"],
          "path": ["api", "auth", "login"]
        }
      }
    },
    {
      "name": "Supervisor Login",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"supervisorCode\": \"SP001\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/auth/login",
          "host": ["{{baseUrl}}"],
          "path": ["api", "auth", "login"]
        }
      }
    },
    {
      "name": "Update Agent Status",
      "request": {
        "method": "PUT",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{authToken}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"status\": \"Busy\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/agents/AG001/status",
          "host": ["{{baseUrl}}"],
          "path": ["api", "agents", "AG001", "status"]
        }
      }
    },
    {
      "name": "Send Direct Message",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{authToken}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"fromCode\": \"SP001\",\n  \"toCode\": \"AG001\",\n  \"content\": \"Please check your queue\",\n  \"type\": \"direct\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/messages/send",
          "host": ["{{baseUrl}}"],
          "path": ["api", "messages", "send"]
        }
      }
    }
  ],
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:3001"
    },
    {
      "key": "authToken",
      "value": ""
    }
  ]
}
```

### **üîß Development Scripts:**

```bash
# ‡πÄ‡∏£‡∏¥‡πà‡∏° development server ‡∏û‡∏£‡πâ‡∏≠‡∏° auto-restart
npm run dev

# ‡∏ó‡∏î‡∏™‡∏≠‡∏ö API endpoints ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
npm run test:api

# ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö database connections  
npm run test:db

# ‡∏£‡∏±‡∏ô‡∏î‡πâ‡∏ß‡∏¢ debug logging
DEBUG=* npm run dev
```

---

## üîå **WebSocket Events Reference**

### **üì° Events ‡∏ó‡∏µ‡πà Client ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ:**

| Event | Description | Data Format | ‡πÉ‡∏ä‡πâ‡πÇ‡∏î‡∏¢ |
|-------|-------------|-------------|---------|
| `agent_connect` | Agent ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket | `{agentCode: "AG001"}` | Agent Desktop |
| `supervisor_connect` | Supervisor ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket | `{supervisorCode: "SP001"}` | Supervisor Dashboard |
| `update_status` | ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Agent | `{agentCode: "AG001", status: "Busy"}` | Agent Desktop |
| `send_message` | ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° | `{fromCode: "SP001", toCode: "AG001", content: "...", type: "direct"}` | Supervisor Dashboard |

### **üì° Events ‡∏ó‡∏µ‡πà Server ‡∏à‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ Client:**

| Event | Description | Data Format | ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ |
|-------|-------------|-------------|-------|
| `connection_success` | ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à | `{agentCode: "AG001", status: "connected"}` | ‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ |
| `connection_error` | ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß | `{message: "Agent code required"}` | ‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ |
| `agent_status_update` | ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Agent ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô | `{agentCode: "AG001", status: "Busy", timestamp: "..."}` | Supervisors |
| `new_message` | ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà | `{messageId: "...", fromCode: "SP001", content: "...", type: "direct"}` | Recipients |
| `agent_connected` | Agent ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö | `{agentCode: "AG001", timestamp: "..."}` | Supervisors |
| `agent_disconnected` | Agent ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö | `{agentCode: "AG001", timestamp: "..."}` | Supervisors |

---

## ‚úÖ **Backend Completion Checklist**

### **üìã ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ:**
- [ ] Server ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ errors
- [ ] ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ SQLite ‡πÅ‡∏•‡∏∞ MongoDB ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
- [ ] API endpoints ‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
- [ ] WebSocket connections ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
- [ ] CORS settings ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï frontend access
- [ ] Error handling ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÑ‡∏î‡πâ

### **üìã Features ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:**
- [ ] Agent login ‡∏î‡πâ‡∏ß‡∏¢ agent code
- [ ] Supervisor login ‡∏î‡πâ‡∏ß‡∏¢ supervisor code
- [ ] Get team members ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö supervisor
- [ ] Update agent status ‡πÅ‡∏•‡∏∞ broadcast
- [ ] Send direct messages ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á supervisor ‡πÅ‡∏•‡∏∞ agent  
- [ ] Send broadcast messages ‡∏ñ‡∏∂‡∏á agents ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
- [ ] Real-time status updates ‡∏ú‡πà‡∏≤‡∏ô WebSocket
- [ ] Message history retrieval

### **üìã Ready for Frontend Integration:**
- [ ] API documentation ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
- [ ] Sample requests/responses ‡∏û‡∏£‡πâ‡∏≠‡∏°
- [ ] Error codes ‡πÅ‡∏•‡∏∞ messages ‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠
- [ ] WebSocket events documented
- [ ] CORS configured for frontend URLs
- [ ] Authentication middleware ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
- [ ] Database models ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå

---

## üß™ **Backend API Testing Guide**

### **üìã Complete Test Cases ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Backend APIs**

#### **üîß Setup ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö:**
```bash
# 1. ‡πÄ‡∏£‡∏¥‡πà‡∏° Backend Server
cd backend-server
npm start

# 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Server ‡∏û‡∏£‡πâ‡∏≠‡∏°
curl http://localhost:3001/health
# ‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á: {"status":"OK","timestamp":"..."}
```

---

### **üß™ Test Case 1: Health Check API**

**üìù Test Details:**
- **Endpoint:** `GET /health`
- **Purpose:** ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ server ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
- **Authentication:** ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô

**üîß Test Command:**
```bash
curl -X GET http://localhost:3001/health
```

**‚úÖ Expected Response:**
```json
{
  "status": "OK",
  "timestamp": "2024-01-15T10:30:00.000Z",
  "uptime": 1234.567,
  "memory": {
    "used": "45.2 MB",
    "total": "512 MB"
  },
  "databases": {
    "sqlite": "connected",
    "mongodb": "connected"
  }
}
```

**‚ùå Error Cases:**
- Server ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‚Üí Connection refused
- Database ‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ‚Üí Status 500

---

### **üß™ Test Case 2: Agent Login**

**üìù Test Details:**
- **Endpoint:** `POST /api/auth/login`
- **Purpose:** Agent login ‡∏î‡πâ‡∏ß‡∏¢ agent code
- **Authentication:** ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (‡πÄ‡∏õ‡πá‡∏ô login endpoint)

**üîß Valid Login Test:**
```bash
curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "agentCode": "AG001"
  }'
```

**‚úÖ Expected Response:**
```json
{
  "success": true,
  "message": "Login successful",
  "data": {
    "user": {
      "agentCode": "AG001",
      "firstName": "John",
      "lastName": "Smith",
      "role": "agent",
      "teamId": 1,
      "status": "Offline"
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expiresIn": "8h"
  }
}
```

**üîß Invalid Login Test:**
```bash
curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "agentCode": "INVALID"
  }'
```

**‚ùå Expected Error Response:**
```json
{
  "success": false,
  "error": "Invalid agent code",
  "code": "INVALID_CREDENTIALS"
}
```

**üß™ Additional Test Cases:**
```bash
# Test Case 2a: Empty agent code
curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{}'
# Expected: 400 Bad Request

# Test Case 2b: Invalid JSON format
curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d 'invalid-json'
# Expected: 400 Bad Request
```

---

### **üß™ Test Case 3: Supervisor Login**

**üìù Test Details:**
- **Endpoint:** `POST /api/auth/login`
- **Purpose:** Supervisor login ‡∏î‡πâ‡∏ß‡∏¢ supervisor code
- **Authentication:** ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô

**üîß Valid Supervisor Login:**
```bash
curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "supervisorCode": "SP001"
  }'
```

**‚úÖ Expected Response:**
```json
{
  "success": true,
  "message": "Login successful",
  "data": {
    "user": {
      "agentCode": "SP001",
      "firstName": "Sarah",
      "lastName": "Johnson",
      "role": "supervisor",
      "teamId": 1,
      "teamData": [
        {
          "agentCode": "AG001",
          "firstName": "John",
          "status": "Available"
        },
        {
          "agentCode": "AG002", 
          "firstName": "Jane",
          "status": "Busy"
        }
      ]
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expiresIn": "8h"
  }
}
```

---

### **üß™ Test Case 4: Update Agent Status**

**üìù Test Details:**
- **Endpoint:** `PUT /api/agents/{agentCode}/status`
- **Purpose:** ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á agent
- **Authentication:** JWT Token ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô

**üîß Setup Token (‡∏ó‡∏≥‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö):**
```bash
# 1. Login ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö token
TOKEN=$(curl -s -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"agentCode": "AG001"}' | \
  grep -o '"token":"[^"]*"' | cut -d'"' -f4)

echo "Token: $TOKEN"
```

**üîß Valid Status Update:**
```bash
curl -X PUT http://localhost:3001/api/agents/AG001/status \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "status": "Busy"
  }'
```

**‚úÖ Expected Response:**
```json
{
  "success": true,
  "message": "Status updated successfully",
  "data": {
    "agentCode": "AG001",
    "oldStatus": "Available",
    "newStatus": "Busy",
    "timestamp": "2024-01-15T10:35:00.000Z"
  }
}
```

**üß™ Error Test Cases:**
```bash
# Test Case 4a: Invalid status
curl -X PUT http://localhost:3001/api/agents/AG001/status \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"status": "InvalidStatus"}'
# Expected: 400 Bad Request

# Test Case 4b: No authentication
curl -X PUT http://localhost:3001/api/agents/AG001/status \
  -H "Content-Type: application/json" \
  -d '{"status": "Busy"}'
# Expected: 401 Unauthorized

# Test Case 4c: Invalid agent code
curl -X PUT http://localhost:3001/api/agents/INVALID/status \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"status": "Busy"}'
# Expected: 404 Not Found
```

---

### **üß™ Test Case 5: Get Team Members**

**üìù Test Details:**
- **Endpoint:** `GET /api/teams/{supervisorCode}/agents`
- **Purpose:** ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ agents ‡πÉ‡∏ô‡∏ó‡∏µ‡∏°
- **Authentication:** JWT Token ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô

**üîß Setup Supervisor Token:**
```bash
SUPERVISOR_TOKEN=$(curl -s -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"supervisorCode": "SP001"}' | \
  grep -o '"token":"[^"]*"' | cut -d'"' -f4)
```

**üîß Valid Request:**
```bash
curl -X GET http://localhost:3001/api/teams/SP001/agents \
  -H "Authorization: Bearer $SUPERVISOR_TOKEN"
```

**‚úÖ Expected Response:**
```json
{
  "success": true,
  "data": {
    "team": {
      "teamId": 1,
      "teamName": "Customer Service",
      "supervisorCode": "SP001"
    },
    "agents": [
      {
        "agentCode": "AG001",
        "firstName": "John",
        "lastName": "Smith",
        "status": "Available",
        "lastStatusChange": "2024-01-15T10:00:00.000Z"
      },
      {
        "agentCode": "AG002",
        "firstName": "Jane",
        "lastName": "Doe", 
        "status": "Busy",
        "lastStatusChange": "2024-01-15T09:30:00.000Z"
      }
    ],
    "statistics": {
      "totalAgents": 2,
      "available": 1,
      "busy": 1,
      "break": 0,
      "offline": 0
    }
  }
}
```

---

### **üß™ Test Case 6: Send Message**

**üìù Test Details:**
- **Endpoint:** `POST /api/messages/send`
- **Purpose:** ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á supervisor ‡πÅ‡∏•‡∏∞ agent
- **Authentication:** JWT Token ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô

**üîß Direct Message Test:**
```bash
curl -X POST http://localhost:3001/api/messages/send \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $SUPERVISOR_TOKEN" \
  -d '{
    "fromCode": "SP001",
    "toCode": "AG001",
    "content": "Please check your queue when you have time",
    "type": "direct",
    "priority": "normal"
  }'
```

**‚úÖ Expected Response:**
```json
{
  "success": true,
  "message": "Message sent successfully",
  "data": {
    "messageId": "msg_1642251600000",
    "fromCode": "SP001",
    "toCode": "AG001", 
    "content": "Please check your queue when you have time",
    "type": "direct",
    "priority": "normal",
    "timestamp": "2024-01-15T10:40:00.000Z",
    "isRead": false
  }
}
```

**üîß Broadcast Message Test:**
```bash
curl -X POST http://localhost:3001/api/messages/send \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $SUPERVISOR_TOKEN" \
  -d '{
    "fromCode": "SP001",
    "toTeamId": 1,
    "content": "Team meeting at 2 PM today",
    "type": "broadcast",
    "priority": "high"
  }'
```

**‚úÖ Expected Response:**
```json
{
  "success": true,
  "message": "Broadcast message sent successfully",
  "data": {
    "messageId": "msg_1642251660000",
    "fromCode": "SP001",
    "toTeamId": 1,
    "content": "Team meeting at 2 PM today",
    "type": "broadcast",
    "priority": "high",
    "timestamp": "2024-01-15T10:41:00.000Z",
    "recipients": ["AG001", "AG002", "AG003"]
  }
}
```

---

### **üß™ Test Case 7: Message History**

**üìù Test Details:**
- **Endpoint:** `GET /api/messages/history`
- **Purpose:** ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
- **Authentication:** JWT Token ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô

**üîß Get Agent Messages:**
```bash
curl -X GET "http://localhost:3001/api/messages/history?agentCode=AG001&limit=10" \
  -H "Authorization: Bearer $TOKEN"
```

**‚úÖ Expected Response:**
```json
{
  "success": true,
  "data": {
    "messages": [
      {
        "messageId": "msg_1642251600000",
        "fromCode": "SP001",
        "toCode": "AG001",
        "content": "Please check your queue when you have time",
        "type": "direct",
        "priority": "normal",
        "timestamp": "2024-01-15T10:40:00.000Z",
        "isRead": false
      }
    ],
    "pagination": {
      "currentPage": 1,
      "totalMessages": 1,
      "hasMore": false
    }
  }
}
```

---

### **üìä Automated Testing Script**

**üîß ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå `test-api.sh`:**
```bash
#!/bin/bash
echo "üß™ Testing Agent Wallboard Backend APIs..."

BASE_URL="http://localhost:3001"

# Test 1: Health Check
echo "Test 1: Health Check"
curl -s "$BASE_URL/health" | jq '.'
echo ""

# Test 2: Agent Login
echo "Test 2: Agent Login"
AGENT_RESPONSE=$(curl -s -X POST "$BASE_URL/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"agentCode": "AG001"}')
echo $AGENT_RESPONSE | jq '.'

# Extract token
TOKEN=$(echo $AGENT_RESPONSE | jq -r '.data.token')
echo "Token: $TOKEN"
echo ""

# Test 3: Update Status
echo "Test 3: Update Agent Status"
curl -s -X PUT "$BASE_URL/api/agents/AG001/status" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"status": "Busy"}' | jq '.'
echo ""

# Test 4: Supervisor Login
echo "Test 4: Supervisor Login"
SUPERVISOR_RESPONSE=$(curl -s -X POST "$BASE_URL/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"supervisorCode": "SP001"}')
echo $SUPERVISOR_RESPONSE | jq '.'

SUPERVISOR_TOKEN=$(echo $SUPERVISOR_RESPONSE | jq -r '.data.token')
echo ""

# Test 5: Get Team Members
echo "Test 5: Get Team Members"
curl -s -X GET "$BASE_URL/api/teams/SP001/agents" \
  -H "Authorization: Bearer $SUPERVISOR_TOKEN" | jq '.'
echo ""

echo "‚úÖ API Testing completed!"
```

**üöÄ ‡∏£‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö:**
```bash
chmod +x test-api.sh
./test-api.sh
```

---

### **üéØ Test Checklist ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤**

#### **üìã Basic API Testing (Required):**
- [ ] Health check ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
- [ ] Agent login ‡∏î‡πâ‡∏ß‡∏¢ valid code
- [ ] Agent login ‡∏î‡πâ‡∏ß‡∏¢ invalid code (‡∏ï‡πâ‡∏≠‡∏á error)
- [ ] Supervisor login ‡∏î‡πâ‡∏ß‡∏¢ valid code
- [ ] Update agent status ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
- [ ] Get team members ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
- [ ] Send direct message ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
- [ ] Message history ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ

#### **üìã Error Handling Testing (Advanced):**
- [ ] Missing authentication token
- [ ] Invalid JSON format
- [ ] Missing required fields
- [ ] Invalid status values
- [ ] Network timeout handling
- [ ] Database connection errors

#### **üìã Integration Testing (Optional):**
- [ ] Status update ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô supervisor dashboard
- [ ] Message ‡∏™‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ real-time
- [ ] Multiple agents ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
- [ ] WebSocket events ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

---

## üéØ **Next Steps**

‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à Backend code ‡πÅ‡∏•‡πâ‡∏ß ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏Ñ‡∏∑‡∏≠:

1. **üñ•Ô∏è 6.6.3 Frontend Applications** - ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ API ‡πÉ‡∏ô React ‡πÅ‡∏•‡∏∞ Electron
2. **üìÖ 6.2 Development Plan** - ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡∏≤‡∏° 14-day roadmap  
3. **üß™ 6.4 Testing Strategy** - ‡∏ó‡∏î‡∏™‡∏≠‡∏ö integration ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á backend ‡πÅ‡∏•‡∏∞ frontend

### **üí° ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤:**
- **‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏Å‡πà‡∏≠‡∏ô** ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á
- **‡πÉ‡∏ä‡πâ console.log ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà** ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö debugging
- **‡∏ó‡∏î‡∏™‡∏≠‡∏ö API ‡∏î‡πâ‡∏ß‡∏¢ Postman** ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ frontend
- **‡∏≠‡πà‡∏≤‡∏ô error messages ‡πÉ‡∏´‡πâ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î** - ‡∏°‡∏±‡∏Å‡∏à‡∏∞‡∏ö‡∏≠‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÑ‡∏î‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
- **Monitor database logs** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö data flow

### **üîß ‡∏Å‡∏≤‡∏£ Debug Backend Issues:**
1. **‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö logs** ‡πÉ‡∏ô terminal ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ô server
2. **‡∏î‡∏π error responses** ‡∏à‡∏≤‡∏Å API calls
3. **‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö database connections** ‡∏î‡πâ‡∏ß‡∏¢ health check endpoint
4. **‡∏•‡∏≠‡∏á restart server** ‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡πâ‡∏î
5. **‡πÉ‡∏ä‡πâ Postman** ‡∏ó‡∏î‡∏™‡∏≠‡∏ö API ‡πÅ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å frontend

---

## üìû **Need Help?**

**‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏±‡∏ö Backend:**

**üîß Server Issues:**
- **Port conflicts:** ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô PORT ‡πÉ‡∏ô .env file
- **Module not found:** ‡∏£‡∏±‡∏ô `npm install` ‡πÉ‡∏´‡∏°‡πà
- **Permission denied:** ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö file permissions

**üóÑÔ∏è Database Issues:**
- **SQLite errors:** ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö database file path
- **MongoDB errors:** ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö MongoDB service running
- **Connection timeouts:** ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö network ‡πÅ‡∏•‡∏∞ firewall

**‚ö° WebSocket Issues:**
- **Connection failed:** ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö CORS settings
- **Events not working:** ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö event names ‡πÅ‡∏•‡∏∞ data format
- **Multiple connections:** ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö connection management

**üöÄ Performance Issues:**
- **Slow API responses:** ‡πÄ‡∏û‡∏¥‡πà‡∏° database indexes
- **Memory leaks:** ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö unclosed database connections
- **High CPU usage:** ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö infinite loops ‡∏´‡∏£‡∏∑‡∏≠ heavy operations

**üéâ Backend Server ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤! ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á Agent Wallboard System** üí™

**Happy Backend Development! üöÄ**